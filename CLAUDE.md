# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**TherapyLens** is a frontend-only React application that provides AI-powered behavioral insights for therapists through real-time eye tracking and breathing analysis. The application processes webcam data locally in the browser, sends anonymized behavioral patterns to Claude API for therapeutic insights, and maintains strict privacy standards (no video/audio recording, local-only processing).

## Development Commands

```bash
# Install dependencies
npm install

# Start dev server (Vite on port 3000)
npm run dev

# Build for production
npm run build

# Preview production build
npm run preview

# Lint source files
npm run lint
```

## Critical Runtime Requirements

- **Webcam access requires HTTPS or localhost** - Vite config includes commented-out HTTPS option in `vite.config.js:12`. Enable for real webcam testing.
- **Claude API calls require authentication** - Current implementation in `src/App.jsx:179-189` omits `x-api-key` header. Add via environment variable:
  - Create `.env` with `VITE_ANTHROPIC_KEY=your_key`
  - Add header: `'x-api-key': import.meta.env.VITE_ANTHROPIC_KEY`
  - Ensure `.env` is in `.gitignore`

## Architecture

### Single-Page Application Structure

- **Frontend-only**: No backend server. All processing happens in browser.
- **State management**: React hooks (no Redux/Zustand). Complex state lives in `src/App.jsx`.
- **Data flow**: Simulated metrics → Alerts system → Claude API analysis → UI display
- **Storage**: Browser memory only. Export functionality provides anonymous JSON reports.

### Key Files

- **`src/App.jsx`** (primary file, ~800 lines)
  - Session lifecycle management
  - Simulated behavioral metrics generation (eye contact, breathing, gaze)
  - Alert logic with configurable thresholds
  - Claude API integration for real-time insights and post-session reports
  - All UI components (tabs, charts, modals)

- **`src/main.jsx`** - React entry point, mounts App component

- **`tailwind.config.js`** - Custom color tokens under `theme.extend.colors.therapy` (primary, secondary, success, warning, danger, info). Use these for consistent branding.

- **`vite.config.js`** - Dev server config (port 3000, HTTPS comment, manual chunks for React and charts)

### Data Schema

**Metrics History** (`metricsHistory` array):
```javascript
{
  time: number,        // Minutes since session start
  eyeContact: number,  // Percentage (0-100)
  breathing: number,   // Breaths per minute
  gaze: number         // Gaze stability percentage (0-100)
}
```

**Alerts** (generated by `checkForAlerts` in `src/App.jsx:114-140`):
```javascript
{
  id: number,
  severity: 'warning' | 'critical',
  message: string,
  minute: number,
  timestamp: Date
}
```

## Configuration & Thresholds

### Alert Thresholds (src/App.jsx:114-140)

Hardcoded values that trigger behavioral alerts:
- Hyperventilation: `breathingRate > 25` bpm → Critical alert
- Breathing increase: `breathingRate > baseline * 1.5` → Warning
- Low eye contact: `eyeContact < 20%` (after 45s) → Warning
- Dissociation indicator: `gazeStability > 95%` (after 90s) → Warning
- Anxiety indicator: `gazeStability < 30%` → Warning

### Claude Insights Frequency (src/App.jsx:109)

Triggered every 2 minutes when `sessionDuration % 120 === 0`. Modify the modulo value to change frequency (e.g., `% 180` for every 3 minutes).

### Patient Baselines (src/App.jsx:18-19)

Default values:
- `baselineBreathing: 14` bpm
- `baselineEyeContact: 45%`

These can be adjusted per-patient in the "Patient Baseline" tab UI.

## Claude API Integration

Two API call sites in `src/App.jsx`:

1. **Real-time insights** (`generateClaudeInsight`, line 153-201)
   - Called every 2 minutes during active session
   - Sends recent metrics averages and alerts
   - Returns 2-3 sentence therapeutic guidance
   - Model: `claude-sonnet-4-20250514`, max_tokens: 200

2. **Post-session report** (`generateSessionReport`, line 252+)
   - Called when session ends
   - Comprehensive analysis with timeline and patterns
   - Returns structured clinical insights
   - Model: `claude-sonnet-4-20250514`, max_tokens: 1000

## Privacy & Security Architecture

**Never stored/transmitted:**
- Video recordings
- Audio recordings
- Facial images
- Patient identifying information
- Session dialogue content

**Temporary storage (browser memory only):**
- Anonymized behavioral metrics (eye contact %, breathing rate, gaze stability)
- Timestamps and durations
- Alert notifications
- AI-generated insights (no patient identifiers sent to API)

**Data lifecycle:**
1. During session: metrics in React state
2. After session: exportable as anonymous JSON
3. Deletion: user-initiated, clears all state

## Implementation Status

### Currently Simulated (not real computer vision)
- Eye tracking (simulated in `src/App.jsx:78-105`)
- Breathing rate detection (random variation around baseline)
- Gaze stability tracking (simulated fluctuations)

### Future Integration Points
- WebGazer.js for real eye tracking
- MediaPipe Pose for actual breathing detection via chest movement
- Facial expression micro-analysis
- src/ML/emotions.py (stub for future emotion recognition)

## Known Issues

- **Export mismatch** (copilot-instructions.md, line 45): `src/App.jsx` defines `const App = () => {...}` but may export as `TherapyLens`. Verify export is `export default App;` to match import in `src/main.jsx:3`.

## Styling & UI

- **Tailwind utility-first** - All components styled with Tailwind classes
- **Custom theme tokens** - Use `therapy.*` color classes (e.g., `text-therapy-primary`, `bg-therapy-warning`)
- **Charts** - Recharts library, expects `metricsHistory` data format
- **Icons** - Lucide React (Eye, Activity, AlertCircle, Brain, etc.)
- **Custom animations** - Defined in `tailwind.config.js:21-34` (pulse-slow, fade-in, slide-up)

## Development Patterns

### Local-First, Privacy-First
When adding features, maintain local-only processing. Never add server-side persistence without explicit privacy safeguards and user consent.

### Metrics Collection
All metric generation and alert checking happens in `useEffect` hooks watching `sessionActive`, `sessionPaused`, and `sessionDuration`. Metrics are pushed to `metricsHistory` array every 3 seconds.

### Tab-Based UI
Main interface uses tab navigation (`activeTab` state: 'monitor', 'insights', 'baseline', 'alerts', 'privacy'). Each tab renders different content within the main component.

## Browser Compatibility

**Required:**
- WebRTC for webcam (Chrome 90+, Firefox 88+, Safari 14+, Edge 90+)
- ES6+ JavaScript support
- CSS Grid and Flexbox
- Fetch API for Claude calls

## Debugging Tips

- **Webcam not working**: Check HTTPS/localhost requirement, browser permissions, console errors from `navigator.mediaDevices.getUserMedia`
- **Claude calls failing**: Check Network tab for API errors, verify API key in headers, or mock responses for offline dev
- **Metrics not updating**: Ensure session is started AND not paused, check `metricsIntervalRef` in console
